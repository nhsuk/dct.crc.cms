schedules:
- cron: "0 12 * * 0"
  displayName: Weekly SonarQube build
  branches:
    include:
    - main
  always: true

pool:
  vmImage: ubuntu-latest

steps:
  
- task: SonarQubePrepare@5
  inputs:
    SonarQube: 'SonarQube'
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: 'DCT_Campaigns_Resource_Centre'
    cliProjectName: 'DCT_Campaigns_Resource_Centre'
    cliSources: '.'
    extraProperties: |
      sonar.exclusions = campaignresourcecentre/**/migrations/*, campaignresourcecentre/dependency-scan-results/dependency-check-report.html
- task: dependency-check-build-task@6
  inputs:
    projectName: 'dct-campaign-resource-centre'
    reportsDirectory: '$(System.DefaultWorkingDirectory)/campaignresourcecentre/dependency-scan-results'
    scanPath: '$(Build.SourcesDirectory)'
    format: "JUNIT"
    additionalArguments: --format "HTML"
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '$(System.DefaultWorkingDirectory)/campaignresourcecentre/dependency-scan-results/*junit.xml'
    testRunTitle: 'Dependency check'
    searchFolder: '$(Common.TestResultsDirectory)'
- task: SonarQubeAnalyze@5
