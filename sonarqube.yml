schedules:
- cron: "0 12 * * 0"
  displayName: Weekly SonarQube build
  branches:
    include:
    - main
  always: true

pool:
  vmImage: ubuntu-latest

steps:
  
- task: SonarQubePrepare@5
  inputs:
    SonarQube: 'SonarQube'
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: 'DCT_Campaigns_Resource_Centre'
    cliProjectName: 'DCT_Campaigns_Resource_Centre'
    cliSources: '.'
    extraProperties: |
      sonar.exclusions = campaignresourcecentre/**/migrations/*
- task: OWASPDependencyCheck@0
  displayName: OWASP Dependency Check
  inputs:
    outputDirectory: '$(System.DefaultWorkingDirectory)/campaignresourcecentre/dependency-scan-results'
    scanDirectory: '$(Build.SourcesDirectory)'
    outputFormat: 'JUNIT'
    useSonarQubeIntegration: true
    additionalArguments: --format "HTML"
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit' # Options: JUnit, NUnit, VSTest, xUnit, cTest
    testResultsFiles: '$(System.DefaultWorkingDirectory)/campaignresourcecentre/dependency-scan-results/*junit.xml'
    searchFolder: '$(Common.TestResultsDirectory)'
    testRunTitle: Dependency Check # Optional
- task: SonarQubeAnalyze@5
