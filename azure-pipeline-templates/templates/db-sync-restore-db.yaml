steps:
- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(db-user)" \
      -e PGPASSWORD \
      postgres:16 \
      psql -d "$(db-name)" \
      -c "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '$(db-name)' AND pid <> pg_backend_pid();"
  displayName: End connections to target database
  env:
    PGPASSWORD: $(db-pass)

- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(postgresqlAdminUser)" \
      -e PGPASSWORD \
      postgres:16 \
      dropdb --if-exists $(db-name)
  displayName: Delete target database
  env:
    PGPASSWORD: $(postgresqlAdminPassword)

- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(postgresqlAdminUser)" \
      -e PGPASSWORD \
      postgres:16 \
      createdb --owner=$(db-user) $(db-name)
  displayName: Recreate target database
  env:
    PGPASSWORD: $(postgresqlAdminPassword)

- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(postgresqlAdminUser)" \
      -e PGPASSWORD \
      postgres:16 \
      psql -d "$(db-name)" \
      -c "ALTER SCHEMA public OWNER TO $(db-user);"
  displayName: Change schema ownership
  env:
    PGPASSWORD: $(postgresqlAdminPassword)

- task: DownloadPipelineArtifact@2
  condition: ${{ eq(parameters.useArtifact, True) }}
  inputs:
    artifact: ${{parameters.dumpPrefix}}-db.dump
    path: $(Build.SourcesDirectory)

- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(postgresqlAdminUser)" \
      -e PGPASSWORD \
      -v $(pwd)/${{parameters.dumpPrefix}}-db-dump.dump:/${{parameters.dumpPrefix}}-db.dump \
      postgres:16 \
      pg_restore --no-acl --no-owner -d "$(db-name)" ${{parameters.dumpPrefix}}-db.dump
  displayName: Copy ${{parameters.dumpPrefix}} to target database
  env:
    PGPASSWORD: $(postgresqlAdminPassword)

- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(postgresqlAdminUser)" \
      -e PGPASSWORD \
      postgres:16 \
      psql -d "$(db-name)" \
      -c "ALTER DATABASE $(db-name) OWNER TO $(db-user);"
  displayName: Change database ownership
  env:
    PGPASSWORD: $(postgresqlAdminPassword)

- script: |
    set -e
    docker run \
      -e PGHOST="$(db-host)" \
      -e PGUSER="$(postgresqlAdminUser)" \
      -e PGPASSWORD \
      postgres:16 \
      psql -d "$(db-name)" \
      -c "REASSIGN OWNED BY $(postgresqlAdminUser) TO $(db-user);"
  displayName: Change tables ownership
  env:
    PGPASSWORD: $(postgresqlAdminPassword)
