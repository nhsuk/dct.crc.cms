steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: ${{parameters.VaultId}}'
  inputs:
    azureSubscription: ${{parameters.azureVaultSubscription}}
    KeyVaultName: ${{parameters.VaultId}}
    SecretsFilter: DBPass, DBName, DBHost, DBUser

- task: DownloadPipelineArtifact@2
  inputs:
    artifact: 'psql_commands_scripts'
    path: '$(Build.SourcesDirectory)/psql_commands_scripts'

- task: DownloadPipelineArtifact@2
  inputs:
    artifact: '${{parameters.artifactPrefix}}-db.dump'
    path: $(Build.SourcesDirectory)

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/psql_commands_scripts/:/psql_commands_scripts/ \
      postgres:11 \
      psql -d "$(DBName)" -f "/psql_commands_scripts/drop_user_constraints.csv"
  displayName: 'Drop user based constraints'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/psql_commands_scripts/:/psql_commands_scripts/ \
      postgres:11 \
      psql -d "$(DBName)" -f "/psql_commands_scripts/add_modified_user_constraints.csv"
  displayName: 'Add modified user based constraints'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      postgres:11 \
      psql -d "$(DBName)" -c "DELETE FROM users_user"
  displayName: 'Delete prod users'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/psql_commands_scripts/:/psql_commands_scripts/ \
      postgres:11 \
      psql -d "$(DBName)" -f "/psql_commands_scripts/drop_user_constraints.csv"
  displayName: 'Drop user based constraints again'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/${{parameters.artifactPrefix}}-db-dump.dump:/${{parameters.artifactPrefix}}-db.dump \
      postgres:11 \
      pg_restore --no-acl --no-owner --clean -d "$(DBName)" -t "users_user" -t "otp_totp_totpdevice" -t "users_user_groups" -t "users_user_user_permissions" -t "wagtailusers_userprofile" ${{parameters.artifactPrefix}}-db.dump 
  displayName: 'Restore ${{parameters.artifactPrefix}} users to target database'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/psql_commands_scripts/:/psql_commands_scripts/ \
      postgres:11 \
      psql -d "$(DBName)" -f "/psql_commands_scripts/add_original_user_indexes.csv"
  displayName: 'Readd original user based indexes'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/psql_commands_scripts/:/psql_commands_scripts/ \
      postgres:11 \
      psql -d "$(DBName)" -f "/psql_commands_scripts/add_original_user_constraints.csv"
  displayName: 'Readd original user based constraints'