steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: ${{parameters.VaultId}}'
  inputs:
    azureSubscription: ${{parameters.azureVaultSubscription}}
    KeyVaultName: ${{parameters.VaultId}}
    SecretsFilter: DBPass, DBHost, DBUser

- task: DownloadPipelineArtifact@2
  inputs:
    artifact: 'prod-db.dump'
    path: $(Build.SourcesDirectory)

- task: DownloadPipelineArtifact@2
  inputs:
    artifact: '${{parameters.envrionment}}-db.dump'
    path: $(Build.SourcesDirectory)

- task: AzureCLI@2
  continueOnError: true
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/prod-db-dump.dump:/prod-db.dump \
      -v $(pwd)/${{parameters.envrionment}}-db-dump.dump:/${{parameters.envrionment}}-db.dump \
      postgres:11 \
      psql -d "${{parameters.DBName}}" \
      -c "SELECT pg_terminate_backend(pg_stat_activity.pid) FROM pg_stat_activity WHERE pg_stat_activity.datname = '${{parameters.DBName}}' AND pid <> pg_backend_pid();"
  displayName: 'End connections to target database'

- task: AzureCLI@2
  continueOnError: true
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az postgres db delete \
      --name "${{parameters.DBName}}" \
      --resource-group "${{parameters.ResourceGroup}}" \
      --server-name "${{parameters.Server}}" \
      --yes \
      --debug
  displayName: 'Delete target database'

- task: AzureCLI@2
  continueOnError: true
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az postgres db create \
      --name "${{parameters.DBName}}" \
      --resource-group "${{parameters.ResourceGroup}}" \
      --server-name "${{parameters.Server}}" \
      --debug
  displayName: 'Recreate target database'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/db-dump.dump:/db.dump \
      postgres:11 \
      pg_restore --no-acl --no-owner -d "${{parameters.DBName}}" prod-db.dump
  displayName: 'Copy prod to target database'

- task: AzureCLI@2
  continueOnError: true
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/${{parameters.envrionment}}-db-dump.dump:/${{parameters.envrionment}}-db.dump \
      postgres:11 \
      psql -d "${{parameters.DBName}}" \
      -c "copy (SELECT 'ALTER TABLE '||constrained_table||' DROP CONSTRAINT '||constraint_name||'; ALTER TABLE '||constrained_table||' ADD CONSTRAINT '||constraint_name||' FOREIGN KEY ('||fk_column||') REFERENCES users_user('||ref_column||') '||on_delete||' '||def||';'
        FROM (
            SELECT
                relname AS constrained_table,
                conname AS constraint_name,
                (SELECT column_name
                    FROM information_schema.columns
                    WHERE table_name=relname
                        AND ordinal_position=conkey[1]) AS fk_column,
                (SELECT column_name
                    FROM information_schema.columns
                    WHERE table_name=relname
                        AND ordinal_position=confkey[1]) AS ref_column,
                (SELECT
                    CASE WHEN NOT is_nullable = 'NO' THEN 'ON DELETE CASCADE'
                    ELSE 'ON DELETE SET NULL'
                    END
                    FROM information_schema.columns
                    WHERE table_name=relname
                        AND ordinal_position=conkey[1]) AS on_delete,
                CASE WHEN condeferrable AND condeferred THEN 'DEFERRABLE INITIALLY DEFERRED'
                    WHEN condeferrable AND NOT condeferred THEN 'DEFERRABLE INITIALLY IMMEDIATE'
                    ELSE 'NOT DEFERRABLE'
                    END AS def
            FROM pg_constraint
            INNER JOIN pg_class ON conrelid=pg_class.oid
            WHERE contype='f'
                AND confrelid = 'users_user'::regclass)
        AS add_constraints)
        to stdout;" | psql -d "${{parameters.DBName}}"
  displayName: 'Alter user based constraints'

- task: AzureCLI@2
  inputs:
    azureSubscription: ${{parameters.azureStorageSubscription}}
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      docker run \
      -e PGHOST="$(DBHost)" \
      -e PGPASSWORD="$(DBPass)" \
      -e PGUSER="$(DBUser)" \
      -v $(pwd)/${{parameters.environment}}-db-dump.dump:/${{parameters.environment}}-db.dump \
      postgres:11 \
      pg_restore --no-acl --no-owner --clean -d "${{parameters.DBName}}" -t "users_user" -t "otp_totp_totpdevice" -t "users_user_groups" -t "users_user_user_permissions" -t "wagtailusers_userprofile" ${{parameters.environment}}-db.dump 
  displayName: 'Restore non-prod users to target database'
