steps:
- task: AzureKeyVault@2
  displayName: 'Azure Key Vault: ${{parameters.VaultId}}'
  inputs:
    azureSubscription: ${{parameters.azureVaultSubscription}}
    KeyVaultName: ${{parameters.VaultId}}
    SecretsFilter: default--db-pass, default--db-name, default--db-host, default--db-user

- task: AzureKeyVault@2
  displayName: 'Azure Key Vault: Admin'
  inputs:
    azureSubscription: dct-crccms-${{parameters.env}}
    KeyVaultName: dct-crccms-kv2-${{parameters.env}}-uks
    SecretsFilter: postgresqlAdminUser, postgresqlAdminPassword

- template: ./db-sync-download-dump.yaml
  parameters:
    dumpPrefix: ${{ parameters.environment }}_users
    usersOnly: True

- template: ./db-sync-restore-db.yaml
  parameters:
    dumpPrefix: prod
    useArtifact: true

- template: ./db-sync-restore-users.yaml
  parameters:
    dumpPrefix: ${{ parameters.environment }}_users

- template: ./db-sync-download-dump.yaml
  parameters:
    dumpPrefix: ${{ parameters.environment }}
    # Added for now so that pipeline artifact can be used for local dev until upload available
    publishDump: true

# TODO: once CRC 'feat' subscription established, upload db dump to it for use in local dev
# - template: ./db-sync-upload-blob.yaml
#   parameters:
#     azureStorageSubscription: ${{ parameters.azureStorageSubscription}}
#     StorageAccountNameDbDump: $(StorageAccountNameDbDump)
#     BlobStorageKeyDbDump: $(BlobStorageKeyDbDump)
#     BlobStorageContainerNameDbDump: $(BlobStorageContainerNameDbDump)
#     dumpPrefix: ${{ parameters.environment }}
