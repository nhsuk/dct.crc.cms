parameters:
  - name: env
    type: string
  - name: region
    type: string
    default: uks
  - name: version
    type: string
  - name: devInstance
    type: string
    default: ''
  - name: dryrun
    type: boolean
    default: false

steps:
  - ${{ if parameters.dryrun }}:
    - bash: |
        echo "##vso[task.logissue type=warning;]Running in dryrun mode - skipping new container app revision"
        echo "##vso[task.complete result=SucceededWithIssues;]"
      displayName: "Dry Run Warning"
  - bash: |
      suffix="${{ coalesce(parameters.devInstance, format('{0}-{1}', parameters.env, parameters.region)) }}"
      shortSuffix=$(echo "${suffix:0:20}" | sed 's:-*$::')
      echo "Trimmed suffix: $shortSuffix"
      appName="ca-wagtail-$shortSuffix"
      echo "Full name: $appName"
      echo "##vso[task.setvariable variable=APP_NAME]$appName"
    displayName: Get App Name
  - task: AzureCLI@2
    condition: ne('${{ lower(parameters.dryrun) }}', 'true')
    displayName: Deploy Wagtail Container App Revision
    inputs:
      azureSubscription: dct-crccms-${{ parameters.env }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az containerapp revision copy \
          --name $APP_NAME \
          --resource-group dct-crccms-rg-${{ parameters.env }}-${{ parameters.region }} \
          --image dctcampaignsacrproduks.azurecr.io/dct/crc-cms:${{ parameters.version }}
