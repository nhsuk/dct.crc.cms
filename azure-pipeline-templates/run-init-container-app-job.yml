parameters:
  - name: env
    type: string
  - name: region
    type: string
    default: uks
  - name: version
    type: string
  - name: devInstance
    type: string
    default: ''
  - name: dryrun
    type: boolean
    default: false

steps:
  - ${{ if parameters.dryrun }}:
    - bash: |
        echo "##vso[task.logissue type=warning;]Running in dryrun mode - skipping updating and running init container app job"
        echo "##vso[task.complete result=SucceededWithIssues;]"
      displayName: Dry Run Warning
  - bash: |
      suffix="${{ coalesce(parameters.devInstance, format('{0}-{1}', parameters.env, parameters.region)) }}"
      shortSuffix=$(echo "${suffix:0:20}" | sed 's:-*$::')
      echo "Trimmed suffix: $shortSuffix"
      jobName="caj-init-$shortSuffix"
      echo "Full name: $jobName"
      echo "##vso[task.setvariable variable=JOB_NAME]$jobName"
    displayName: Get Job Name
  - task: AzureCLI@2
    condition: ne('${{ lower(parameters.dryRun) }}', 'true')
    displayName: Update and run init container app job
    name: run_job
    inputs:
      azureSubscription: dct-crccms-${{ parameters.env }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        export RESOURCE_GROUP_NAME="${ORG}-${APP}-rg-${ENV}-${REGION}"

        echo "‚¨ÜÔ∏è Updating image..."
        az containerapp job update \
          --name $JOB_NAME \
          --resource-group $RESOURCE_GROUP_NAME \
          --image dctcampaignsacrproduks.azurecr.io/dct/crc-cms:${{ parameters.version }}

        echo "üé¨ Starting job..."
        export JOB_EXECUTION_NAME=$(az containerapp job start \
          --name $JOB_NAME \
          --resource-group $RESOURCE_GROUP_NAME \
          --query 'name' \
          --output tsv)

        echo "$JOB_EXECUTION_NAME is progress"
        echo "##vso[task.setvariable variable=JOB_EXECUTION_NAME;isOutput=true]$JOB_EXECUTION_NAME"

        echo "üï∞Ô∏è Waiting for job to complete..."
        while true; do
          sleep 10
          job_status=$(az containerapp job execution show \
            --name $JOB_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query 'properties.status' \
            --output tsv \
            --job-execution-name $JOB_EXECUTION_NAME)

          if [ "$job_status" == "Succeeded" ]; then
            echo "‚úÖ Job completed successfully"
            exit 0
          elif [ "$job_status" == "Failed" ]; then
            echo "‚ùå Job failed"
            exit 1
          else
            echo "‚è≥ Job is ${job_status}"
          fi
        done
    env:
      ORG: dct
      APP: crccms
      ENV: ${{ parameters.env }}
      REGION: ${{ parameters.region }}
      JOB_NAME: $(JOB_NAME)

  - task: AzureCLI@2
    condition: and(failed(), ne('${{ lower(parameters.dryRun) }}', 'true'))
    displayName: Fetch init job logs
    inputs:
      azureSubscription: dct-crccms-${{ parameters.env }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        set -e
        export JOB_EXECUTION_NAME="$(run_job.JOB_EXECUTION_NAME)"

        echo "üìã Fetching logs for execution ${JOB_EXECUTION_NAME} (may take up to 3 minutes to be available)..."

        if [ "${{ parameters.env }}" == "prod" ]; then
          WORKSPACE_ID="a4074ac3-af3b-4878-b01c-222622ee9154"
        else
          WORKSPACE_ID="4f437aad-44d1-4f34-adb6-1904be0b6b1f"
        fi

        logs_found=false
        for i in {1..6}; do
          sleep 30
          echo "Attempting to fetch logs (attempt $i/6)..."

          log_output=$(az monitor log-analytics query \
            --workspace "${WORKSPACE_ID}" \
            --analytics-query "ContainerAppConsoleLogs | where JobName == '${JOB_NAME}' and ContainerGroupName contains '${JOB_EXECUTION_NAME}' | order by TimeGenerated asc | project TimeGenerated, Log" \
            --output table 2>/dev/null || true)

          if echo "$log_output" | grep -q "TimeGenerated"; then
            echo "$log_output"
            logs_found=true
            break
          fi
        done

        if [ "$logs_found" = false ]; then
          echo "‚ö†Ô∏è Could not find logs for execution ${JOB_EXECUTION_NAME}. Please check the logs manually in Log Analytics."
        fi
    env:
      JOB_NAME: $(JOB_NAME)
