{% extends "base_page.html" %}
{% load static wagtailuserbar wagtailcore_tags wagtailimages_tags navigation_tags util_tags %}

{% block title %}Search{% endblock %}

{% load filters %}

{% block header %}
    <header class="nhsuk-header" role="banner">
  <div class="nhsuk-width-container nhsuk-header__container">
    <div class="nhsuk-header__logo">
      <a class="nhsuk-header__link" href="/" aria-label="Campaign resource centre homepage">
        {% include "molecules/header/dhsc-logo.html" %}
      </a>
    </div>
    <div class="nhsuk-header__content" id="content-header">
      <div class="nhsuk-header__menu-account">
        {% include "molecules/header/account.html" %}
        <div class="nhsuk-header__menu">
          <button class="nhsuk-header__menu-toggle" id="toggle-menu" aria-controls="header-navigation" aria-label="Open menu">Menu</button>
        </div>
      </div>
    </div>
  </div>

  {% primarynav %}
</header>
{% endblock header %}

{% block breadcrumbs %}
    <nav class="nhsuk-breadcrumb" aria-label="Breadcrumb">
        <div class="nhsuk-width-container">
        <ol class="nhsuk-breadcrumb__list">
            <li class="nhsuk-breadcrumb__item">
                <a href="/" class="nhsuk-breadcrumb__link">Home</a>
            </li>
        </ol>

        <p class="nhsuk-breadcrumb__back">
            <a href="/" class="nhsuk-breadcrumb__backlink">Back to Home</a>
        </p>
        </div>
    </nav>
{% endblock %}

{% block content %}
    <div class="govuk-width-container govuk-!-padding-bottom-7">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <h1 class="govuk-heading-xl">Search</h1>
            </div>
        </div>

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="govuk-form-group govuk-!-margin-bottom-0">
                    <!-- <input class="govuk-input resource-search-field govuk-!-width-one-half" id="search-field" name="q" type="search" placeholder="Search for resources" value="{{search_query}}" autocomplete="off" />
                    <button id="submit-search" class="govuk-button" type="submit">Search</button> -->

                    <div class="nhsuk-header__search filter-search-results govuk-!-margin-bottom-8 govuk-!-margin-top-1">
                        <div class="nhsuk-header__search-wrap" id="wrap-search">
                            <div class="search-form">
                                <form class="resource-search-form nhsuk-header__search-form" id="search" action="/search/" method="get" role="search">
                                <label class="nhsuk-u-visually-hidden" for="search-field">Search the CRC website</label>
                                <input class="nhsuk-search__input" id="search-field" name="q" value="{{search_query}}" type="search" placeholder="Search for resources" autocomplete="off">
                                <button id="submit-search" class="nhsuk-search__submit" type="submit">
                                <svg class="nhsuk-icon nhsuk-icon__search" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                                    <path d="M19.71 18.29l-4.11-4.1a7 7 0 1 0-1.41 1.41l4.1 4.11a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.42zM5 10a5 5 0 1 1 5 5 5 5 0 0 1-5-5z"></path>
                                </svg>
                                <span class="nhsuk-u-visually-hidden">Search</span>
                                </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-one-quarter">
                <h3>Filter results by</h3>
                <form class="resource-filter-form" id="resource-filter-form" action="/search/" method="get" role="search">
                    <input type="hidden" name="q" value="{{search_query}}">
                    {% for taxonomy in taxonomies %}
                        <details class="govuk-details resource-filters" data-module="govuk-details">
                            <summary class="govuk-details__summary">
                                <span class="govuk-details__summary-text">
                                    {{ taxonomy.label }}
                                </span>
                            </summary>
                            {% if taxonomy.code == 'TOPIC' or taxonomy.code == 'REGION' or taxonomy.code == 'LANGUAGE' %}
                                <div class="govuk-details__text">
                                    <div class="govuk-form-group">
                                        <label class="govuk-label govuk-visually-hidden" for="{{taxonomy.code}}">{{taxonomy.code|title}}</label>
                                        <select class="govuk-select" id="{{taxonomy.code}}" name="{{taxonomy.code}}" onchange="submitForm()">
                                            <option value="">All</option>
                                            {% for child in taxonomy.children %}
                                                {% if facets_queryset|taxonomies_get:taxonomy.code and facets_queryset|taxonomies_get:taxonomy.code|code_includes:child.code  %}
                                                    <option value="{{ child.code }}" selected>{{ child.label }}</option>
                                                {% else %}
                                                    <option value="{{ child.code }}">{{ child.label }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            {% else %}
                                <div class="govuk-form-group">
                                    <fieldset class="govuk-fieldset" aria-describedby="waste-hint">
                                        <legend class="govuk-fieldset__legend govuk-visually-hidden">{{ taxonomy.label }}</legend>
                                        <div class="govuk-checkboxes  govuk-checkboxes--small" data-module="govuk-checkboxes">
                                            {% for child in taxonomy.children %}
                                                <div class="govuk-checkboxes__item">
                                                    {% if facets_queryset|taxonomies_get:taxonomy.code and facets_queryset|taxonomies_get:taxonomy.code|code_includes:child.code %}
                                                        <input id="{{child.code|slugify}}-input" class="govuk-checkboxes__input" name="{{ taxonomy.code }}" type="checkbox" value="{{ child.code }}" onclick="submitForm()" checked>
                                                    {% else %}
                                                        <input id="{{child.code|slugify}}-input" class="govuk-checkboxes__input" name="{{ taxonomy.code }}" type="checkbox" value="{{ child.code }}" onclick="submitForm()">
                                                    {% endif %}
                                                    <label class="govuk-label govuk-checkboxes__label" for="{{ child.code|slugify }}-input">
                                                        {{ child.label }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </fieldset>
                                </div>
                            {% endif %}
                        </details>
                    {% endfor %}
                    <button id="filter-search" type="submit" class="govuk-button no-js">Filter results</button>
  
                </form>
            </div>
            
                {% include "molecules/search-result/refresh-search.html" %}

        </div>
    </div>

    <noscript>
        <style type="text/css">
            .no-js {
                position: relative;
                visibility: visible;
                left: auto;
                top: auto;
            }
            .taxonomy-tags #taxonomy-tags-reset {
                display: none;
            }
            .taxonomy-tags .taxonomy-tags__child .taxonomy-tags__remove,
            .taxonomy-tags .taxonomy-tags__child input[type=checkbox]{
                display: none;
            }
            .taxonomy-tags .taxonomy-tags__child .taxonomy-tags__child-label {
                cursor: default !important;
            }
        </style>
    </noscript>

    <script>
        if (!("{{facets_queryset|length}}" == "0")) {
            document.getElementById("search-field").focus()
        }

        /**
         * Gets the search value from the form.
         * Creates a query string from the search value.
         * Creates a new XMLHttp request.
         * Outputs the HTML required for the requested campaigns.
         */

        // Initialise default values
        let sortBy = "";
        let queryString = "";

        function submitForm() {
            if("URLSearchParams" in window){
                queryString = "";
                const filterForm = document.getElementById("resource-filter-form");
                queryString = new URLSearchParams(new FormData(filterForm)).toString();
                queryString += "&sort=" + sortBy;
                const xhttp_ss = new XMLHttpRequest();
                xhttp_ss.onreadystatechange = function() {
                    if (this.readyState == 4){
                        if(this.status == 200) {
                            const searchForm = document.getElementById("search-result");
                            searchForm.outerHTML = this.responseText;
                        }
                    }
                }
                xhttp_ss.open("GET", "/render_search/?" + queryString);
                xhttp_ss.send();
                // Update the URL in the browser window to match the search.
                window.history.pushState({}, '', '?' + queryString);
            }
            else {
                const button = document.getElementById("filter-search");
                button.click();
            }
            return queryString;
        }

        function unCheckSubmitForm(elem) {
            const checkbox = document.getElementById(elem.getAttribute("value").toLowerCase());
            if(checkbox) {
                const next = document.activeElement.nextElementSibling;
                checkbox.click();
                next.focus();
            } else {
                //uncheck the filter item
                const select = document.getElementById(elem.getAttribute("parent"));
                select.selectedIndex = 0;

                //resubmit the filter
                submitForm();
            }
        }


        /**
         * Gets the sort by value from the drop down list.
         * Creates a query string.
         * Creates a new XMLHttp request.
         * Outputs the HTML required for the requested campaigns.
         * Update the URL in the browser window.
         */
         function submitSortby(element) {
            sortBy = element.value;
            // Check if query string has a value, set to current URL query if not.
            if(!queryString) {
                url = window.location.href;
                queryString = url.split('?')[1];
            }
            // Check if query string already includes sort value, remove sort value if it does.
            if(queryString.includes("&sort=")) {
                const querySplit = queryString.split("&sort=")[0];
                queryString = querySplit;
            }
            const sortQueryString = queryString + "&sort=" + sortBy;
            const xhttp_sort = new XMLHttpRequest();
            xhttp_sort.onreadystatechange = function() {
                if (this.readyState == 4){
                    if(this.status == 200) {
                        const topics = document.getElementById("search-result");
                        topics.outerHTML = this.responseText;
                    }
                }
            }
            xhttp_sort.open("GET", "/render_search/?" + sortQueryString);
            xhttp_sort.send();
            // Update the URL in the browser window to match the search.
            window.history.pushState({}, '', '?' +  sortQueryString);
            return sortBy;
        }
    </script>
{% endblock %}
