{% extends 'wagtailadmin/base.html' %}
{% load wagtailadmin_tags static %}

{% block titletag %}
  Tag Management Results
{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'tag_management/css/bulk_manage_tags.css' %}" />
{% endblock %}

{% block content %}
  {% include 'wagtailadmin/shared/header.html' with title='Tag Management Results' icon='success' %}

  <div class="nice-padding">
    {% if num_failed == 0 and num_modified > 0 %}
      <div class="help-block help-success">
        <svg class="icon icon-success" aria-hidden="true">
          <use href="#icon-success"></use>
        </svg>Successfully updated {{ num_modified }} page{{ num_modified|pluralize }}!
      </div>
    {% elif num_failed > 0 and num_modified > 0 %}
      <div class="help-block help-warning">
        <svg class="icon icon-warning" aria-hidden="true">
          <use href="#icon-warning"></use>
        </svg>Updated {{ num_modified }} page{{ num_modified|pluralize }}, but {{ num_failed }} page{{ num_failed|pluralize }} failed to update.
      </div>
    {% elif num_failed > 0 %}
      <div class="help-block help-critical">
        <svg class="icon icon-cross" aria-hidden="true">
          <use href="#icon-cross"></use>
        </svg>Failed to update {{ num_failed }} page{{ num_failed|pluralize }}.
      </div>
    {% endif %}

    <p class="operation-text">
      <strong>Operation Mode:</strong>
      {% if operation_mode == 'replace' %}
        Replace (removed existing tags, added new tags)
      {% elif operation_mode == 'remove' %}
        Remove tags
      {% else %}
        Merge (added to existing tags)
      {% endif %}
    </p>

    {% if num_failed > 0 %}
      <div class="help-block help-warning">
        <svg class="icon" aria-hidden="true">
          <use href="#icon-warning"></use>
        </svg>
        {% if num_failed == 1 %}
          {{ num_failed }} page failed to update
        {% else %}
          {{ num_failed }} pages failed to update
        {% endif %}
      </div>
    {% endif %}

    {% if num_modified > 0 %}
      <div class="help-block help-info">
        <svg class="icon" aria-hidden="true">
          <use href="#icon-success"></use>
        </svg>
        {% if num_modified == 1 %}
          {{ num_modified }} page was successfully updated
        {% else %}
          {{ num_modified }} pages were successfully updated
        {% endif %}
      </div>
    {% endif %}

    <h2>Updated Pages</h2>

    {% if change_details %}
      <table class="listing">
        <thead>
          <tr>
            <th>Page</th>
            <th>Page Status</th>
            <th>Updated Tags</th>
            <th>Changes</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          {% for change in change_details %}
            <tr>
              <td>
                <a href="{% url 'wagtailadmin_pages:edit' change.page_id %}" target="_blank" rel="noreferrer">{{ change.page_title }}</a>
              </td>
              <td>
                {% if change.is_draft_only %}
                  <span class="w-status w-status--primary">Draft</span>
                {% elif change.has_draft %}
                  <span class="w-status w-status--label">Live + Draft</span>
                {% else %}
                  <span class="w-status">Live</span>
                {% endif %}
              </td>
              <td>
                {% if change.final_tags %}
                  <div class="tags-container">
                    {% for tag in change.final_tags %}
                      <span class="taxonomy-tag"><span class="tag-label">{{ tag.label }}</span></span>
                    {% endfor %}
                  </div>
                {% else %}
                  <em class="help-text">No tags</em>
                {% endif %}
              </td>
              <td>
                {% if change.tags_added %}
                  <span>{{ change.tags_added|length }} added</span>
                {% endif %}
                {% if change.tags_removed %}
                  <span>{{ change.tags_removed|length }} removed</span>
                {% endif %}
                {% if not change.tags_added and not change.tags_removed %}
                  <em class="help-text">None</em>
                {% endif %}
              </td>
              <td>
                {% if change.error %}
                  <span class="w-status w-status--critical">Failed</span>
                  <br /><small>{{ change.error }}</small>
                {% elif change.had_changes %}
                  {% if change.is_draft_only %}
                    <span class="help-text">Draft updated</span>
                  {% elif change.has_draft %}
                    <span class="help-text">Live + Draft updated</span>
                  {% else %}
                    <span class="help-text">Live updated</span>
                  {% endif %}
                {% else %}
                  <span class="help-text">No changes</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No changes were made.</p>
    {% endif %}

    <div class="button-wrapper">
      <a href="{{ next_url }}" class="button">Back to Pages</a>
    </div>
  </div>
{% endblock %}
