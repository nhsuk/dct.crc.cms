{% extends "wagtailadmin/base.html" %}
{% load wagtailadmin_tags static %}

{% block titletag %}Tag Management Results{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'tag_management/css/bulk_manage_tags.css' %}">
{% endblock %}

{% block content %}
    {% include "wagtailadmin/shared/header.html" with title="Tag Management Results" icon="success" %}

    <div class="nice-padding">
        {# Source Page and Operation Summary #}
        {% if source_page %}
            <div class="help-block source-page-block">
                <strong>Source Page:</strong>
                <a href="{% url 'wagtailadmin_pages:edit' source_page.id %}" target="_blank" rel="noreferrer">
                    {{ source_page.get_admin_display_title }}
                </a>
            </div>
        {% endif %}

        <p class="operation-text">
            <strong>Operation:</strong>
            {% if display_mode == 'comparison' %}
                Manual tag removal and addition
            {% elif display_mode == 'old_new' %}
                Replace tags (remove existing, add from source)
            {% else %}
                Merge tags (add to existing)
            {% endif %}
        </p>

        {% if num_failed > 0 %}
            <div class="help-block help-warning">
                <svg class="icon" aria-hidden="true"><use href="#icon-warning"></use></svg>
                {% if num_failed == 1 %}
                    {{ num_failed }} page failed to update
                {% else %}
                    {{ num_failed }} pages failed to update
                {% endif %}
            </div>
        {% endif %}

        {% if num_modified > 0 %}
            <div class="help-block help-info">
                <svg class="icon" aria-hidden="true"><use href="#icon-success"></use></svg>
                {% if num_modified == 1 %}
                    {{ num_modified }} page was successfully updated
                {% else %}
                    {{ num_modified }} pages were successfully updated
                {% endif %}
            </div>
        {% endif %}

        <h2>Changes Made</h2>
        
        {% if change_details %}
            <table class="listing">
                <thead>
                    <tr>
                        <th>Page</th>
                        {% if display_mode == 'final' %}
                            <th>Final Tags</th>
                        {% elif display_mode == 'old_new' %}
                            <th>Old Tags</th>
                            <th>New Tags</th>
                        {% else %}
                            <th>Tags Removed</th>
                            <th>Tags Added</th>
                        {% endif %}
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for change in change_details %}
                        <tr>
                            <td>
                                <a href="{% url 'wagtailadmin_pages:edit' change.page_id %}" target="_blank" rel="noreferrer">
                                    {{ change.page_title }}
                                </a>
                            </td>
                            
                            {% if display_mode == 'final' %}
                                <td>
                                    {% if change.final_tags %}
                                        {% for tag in change.final_tags %}{{ tag.label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        <em class="help-text">No tags</em>
                                    {% endif %}
                                </td>
                            {% elif display_mode == 'old_new' %}
                                <td>
                                    {% if change.original_tags %}
                                        {% for tag in change.original_tags %}{{ tag.label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        <em class="help-text">No tags</em>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if change.final_tags %}
                                        {% for tag in change.final_tags %}{{ tag.label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        <em class="help-text">No tags</em>
                                    {% endif %}
                                </td>
                            {% else %}
                                <td>
                                    {% if change.tags_removed %}
                                        {% for tag in change.tags_removed %}{{ tag.label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        <em class="help-text">None</em>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if change.tags_added %}
                                        {% for tag in change.tags_added %}{{ tag.label }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                    {% else %}
                                        <em class="help-text">None</em>
                                    {% endif %}
                                </td>
                            {% endif %}
                            
                            <td>
                                {% if change.error %}
                                    <span class="status-tag warning">
                                        <svg class="icon" aria-hidden="true"><use href="#icon-warning"></use></svg>
                                        Failed
                                    </span>
                                    <br><small>{{ change.error }}</small>
                                {% elif change.had_changes %}
                                    <span class="status-tag primary">
                                        Updated
                                    </span>
                                {% else %}
                                    <span class="status-tag">No changes</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No changes were made.</p>
        {% endif %}

        <div class="button-wrapper">
            <a href="{{ next_url }}" class="button">
                Back to Pages
            </a>
        </div>
    </div>
{% endblock %}
