{% extends "base_page.html" %}
{% block title %}Your basket{% endblock %}

{% block breadcrumbs %}
    <nav class="nhsuk-breadcrumb" aria-label="Breadcrumb">
        <div class="nhsuk-width-container">
        <ol class="nhsuk-breadcrumb__list">
            <li class="nhsuk-breadcrumb__item">
                <a href="/" class="nhsuk-breadcrumb__link">Home</a>
            </li>
        </ol>

        <p class="nhsuk-breadcrumb__back">
            <a href="/" class="nhsuk-breadcrumb__backlink">Back to Home</a>
        </p>
        </div>
    </nav>
{% endblock %}

{% block content %}
    
    <div id="resource-order-error-summary" class="govuk-width-container" tabindex="-1">
        {% if has_errors %}
            {% include 'molecules/baskets/basket_errors.html' %}
        {% endif %}
    </div>
    <div class="govuk-width-container govuk-!-padding-bottom-4">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <h1 class="govuk-heading-xl">Your basket</h1>
                <p>Our resources are free to order. Please only order what you need.</p>
            </div>
        </div>

        <div class="govuk-grid-row resources">
            {% if items %}
                {% for index, item in items %}
                <div class="govuk-grid-column-two-thirds">
                    <div class="resource-panel">
                        <div class="govuk-grid-row">
                            <div class="govuk-grid-column-one-third">
                                <div class="left-panel">
                                    <img src="{{ item.item_image_url }}" alt="{% if item.image_alt_text %}{{ item.image_alt_text }}{% endif %}">
                                </div>
                            </div>
                            <div class="govuk-grid-column-two-thirds order-info-panel download">
                                <div>
                                    <h2 class="govuk-!-font-size-24" id="id-{{ item.id }}"><a href="{{ item.item_url }}">{{ item.title }}</a></h2>
                                    <p class="govuk-!-font-size-16 max-order govuk-!-padding-top-2">Maximum order quantity: {{ item.max_quantity }}</p>
                                    <hr>
                                </div>

                                {% include 'molecules/baskets/basket.html' %}

                                <form id="remove_item-{{ item.id }}" action="/baskets/remove_item/" method="POST" aria-label="Remove from basket">
                                    {% csrf_token %}
                                    <fieldset class="govuk-fieldset">
                                        <div class="govuk-form-group govuk-!-padding-top-6">
                                            <input type="hidden" name="item_id" value="{{ item.id }}">
                                            <button name="add-to-basket" class="link-only" aria-describedby="id-{{ item.id }}">Remove from basket</button>
                                        </div>
                                    </fieldset>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                    {% else %}
                        <div class="govuk-grid-column-full govuk-!-padding-bottom-6">
                            <p>Your basket is currently empty!</p>
                        </div>
            {% endif %}
        </div>

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                {% if items %}
                        <p><a href="/orders/address/edit/" class="govuk-button primary-button" role="button" id="proceed-to-checkout">Proceed to checkout</a></p>
                {% endif %}
            </div>
        </div>
    </div>

    {% block extra_js %}
        {% include "static/form_action.html" %}
        {% include "static/render_basket.html" %}
    {% endblock %}
    <script>
        /**
         * Add the event listener to the checkout buton if it exists
         */
        const checkout = document.getElementById("proceed-to-checkout");
        if(checkout) {
            checkout.addEventListener("click", proceedCheckout);
        }

        /**
         * Check if there are errors before proceeding to checkout.
         * Prevent the 'Proceed to checkout' link working if there are.
         * Move the focus to the errors list.
         */
        function proceedCheckout(e) {
            const errorsClass = document.getElementsByClassName("govuk-error-message");
            const valid = document.getElementsByClassName("govuk-error-message govuk-!-display-none");
            const errorSummary = document.getElementById("resource-order-error-summary");
            // Check if the total items in the basket with a potential error message is different from items which have valid values.
            if(errorsClass.length !== valid.length) {
                // Prevent the link from working.
                e.preventDefault();
                // Prevent the events script from running so the page does not reload.
                e.stopImmediatePropagation();
                // Move the focus to the error list.
                checkout.blur();
                errorSummary.focus();
            }
         }

    </script>
{% endblock %}
